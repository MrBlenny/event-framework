defaults: &defaults
  working_directory: ~/project
  docker:
    - image: 'nfour/circleci-node:9'


buildSteps: &buildSteps
  - checkout

  - restore_cache:
      keys:
      - dependencies-{{ checksum "package.json" }}
      - dependencies-

  - run: yarn install

  - save_cache:
      paths:
        - node_modules
      key: dependencies-{{ checksum "package.json" }}

  - run: yarn preversion

version: 2
jobs:
  build:
    <<: *defaults

    steps:
      <<: *buildSteps


  deploy:
    <<: *defaults

    filters:
      tags:
        only: /.+/

    steps:
      <<: *buildSteps

      - run: yarn release

workflows:
  version: 2
  buildAndDeploy:
    jobs:
      - build
      - deploy:
          requires: ['build']
